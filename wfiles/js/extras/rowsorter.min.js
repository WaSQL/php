(function(root,factory){'use strict';if(typeof define==='function'&&define.amd){define('RowSorter',factory)}else if(typeof exports==='object'){module.exports=factory()}else{root.RowSorter=factory()}})(this,function(){'use strict';var $=window.jQuery||!1,arrProto=Array.prototype,touchSupport=!!('ontouchstart' in document),helperAttrName='data-rowsorter',defaults={handler:null,tbody:!0,tableClass:'sorting-table',dragClass:'sorting-row',stickTopRows:0,stickBottomRows:0,onDragStart:null,onDragEnd:null,onDrop:null};function RowSorter(table,opts){if(!(this instanceof RowSorter)){return new RowSorter(table,opts)}
if(typeof table==='string'){table=findTable(table)}
if(is(table,'table')===!1){throw new Error('Table not found.')}
if(table[helperAttrName]instanceof RowSorter){return table[helperAttrName]}
this._options=extend(defaults,opts);this._table=table;this._tbody=table;this._rows=[];this._lastY=!1;this._draggingRow=null;this._firstTouch=!0;this._lastSort=null;this._ended=!0;this._mousedown=bind(mousedown,this);this._mousemove=bind(mousemove,this);this._mouseup=bind(mouseup,this);this._touchstart=bind(touchstart,this);this._touchmove=bind(touchmove,this);this._touchend=bind(touchend,this);this._touchId=null;this._table[helperAttrName]=this;this.init()}
RowSorter.prototype.init=function(){if(this._options.tbody){var bodies=this._table.getElementsByTagName('tbody');if(bodies.length>0){this._tbody=bodies[0]}}
if(typeof this._options.onDragStart!=='function'){this._options.onDragStart=null}
if(typeof this._options.onDrop!=='function'){this._options.onDrop=null}
if(typeof this._options.onDragEnd!=='function'){this._options.onDragEnd=null}
if(typeof this._options.stickTopRows!=='number'||this._options.stickTopRows<0){this._options.stickTopRows=0}
if(typeof this._options.stickBottomRows!=='number'||this._options.stickBottomRows<0){this._options.stickBottomRows=0}
addEvent(this._table,'mousedown',this._mousedown);addEvent(document,'mouseup',this._mouseup);if(touchSupport){addEvent(this._table,'touchstart',this._touchstart);addEvent(this._table,'touchend',this._touchend)}
if('onselectstart' in document){var that=this;addEvent(document,'selectstart',function(e){var ev=e||window.event;if(that._draggingRow!==null){if(ev.preventDefault){ev.preventDefault()}else{ev.returnValue=!1}
return!1}})}};function mousedown(ev){ev=ev||window.event;if(this._start(ev.target||ev.srcElement,ev.clientY)){if(ev.preventDefault){ev.preventDefault()}else{ev.returnValue=!1}
return!1}
return!0}
function touchstart(ev){if(ev.touches.length===1){var touch=ev.touches[0],target=document.elementFromPoint(touch.clientX,touch.clientY);this._touchId=touch.identifier;if(this._start(target,touch.clientY)){if(ev.preventDefault){ev.preventDefault()}else{ev.returnValue=!1}
return!1}}
return!0}
RowSorter.prototype._start=function(target,clientY){if(this._draggingRow){this._end()}
this._rows=this._tbody.rows;if(this._rows.length<2){return!1}
if(this._options.handler){var handlers=qsa(this._table,this._options.handler);if(!handlers||inArray(handlers,target)===-1){return!1}}
var draggingRow=closest(target,'tr');var current_index=rowIndex(this._tbody,draggingRow);if(current_index===-1||(this._options.stickTopRows>0&&current_index<this._options.stickTopRows)||(this._options.stickBottomRows>0&&current_index>=this._rows.length-this._options.stickBottomRows)){return!1}
this._draggingRow=draggingRow;if(this._options.tableClass){addClass(this._table,this._options.tableClass)}
if(this._options.dragClass){addClass(this._draggingRow,this._options.dragClass)}
this._oldIndex=current_index;if(this._options.onDragStart){this._options.onDragStart(this._tbody,this._draggingRow,this._oldIndex)}
this._lastY=clientY;this._ended=!1;addEvent(this._table,'mousemove',this._mousemove);if(touchSupport){addEvent(this._table,'touchmove',this._touchmove)}
return!0};function mousemove(ev){ev=ev||window.event;this._move(ev.target||ev.srcElement,ev.clientY);return!0}
function touchmove(ev){if(ev.touches.length===1){var touch=ev.touches[0],target=document.elementFromPoint(touch.clientX,touch.clientY);if(this._touchId===touch.identifier){this._move(target,touch.clientY)}}
return!0}
RowSorter.prototype._move=function(target,clientY){if(!this._draggingRow){return}
var direction=clientY>this._lastY?1:(clientY<this._lastY?-1:0);if(direction!==0){var hoveredRow=closest(target,'tr');if(hoveredRow&&hoveredRow!==this._draggingRow&&inArray(this._rows,hoveredRow)!==-1){var move=!0;if(this._options.stickTopRows>0||this._options.stickBottomRows>0){var new_index=rowIndex(this._tbody,hoveredRow);if((this._options.stickTopRows>0&&new_index<this._options.stickTopRows)||(this._options.stickBottomRows>0&&new_index>=this._rows.length-this._options.stickBottomRows)){move=!1}}
if(move){moveRow(this._draggingRow,hoveredRow,direction)}
this._lastY=clientY}}};function mouseup(){this._end()}
function touchend(ev){if(ev.changedTouches.length>0&&this._touchId===ev.changedTouches[0].identifier){this._end()}}
RowSorter.prototype._end=function(){if(!this._draggingRow){return!0}
if(this._options.tableClass){removeClass(this._table,this._options.tableClass)}
if(this._options.dragClass){removeClass(this._draggingRow,this._options.dragClass)}
var new_index=rowIndex(this._tbody,this._draggingRow);if(new_index!==this._oldIndex){var previous=this._lastSort;this._lastSort={previous:previous,newIndex:new_index,oldIndex:this._oldIndex};if(this._options.onDrop){this._options.onDrop(this._tbody,this._draggingRow,new_index,this._oldIndex)}}else if(this._options.onDragEnd){this._options.onDragEnd(this._tbody,this._draggingRow,this._oldIndex)}
this._draggingRow=null;this._lastY=!1;this._touchId=null;this._ended=!0;removeEvent(this._table,'mousemove',this._mousemove);if(touchSupport){removeEvent(this._table,'touchmove',this._touchmove)}};RowSorter.prototype.revert=function(){if(this._lastSort!==null){var lastSort=this._lastSort,old_index=lastSort.oldIndex,new_index=lastSort.newIndex,rows=this._tbody.rows,max_index=rows.length-1;if(rows.length>1){if(old_index<max_index){this._tbody.insertBefore(rows[new_index],rows[old_index+(new_index>old_index?0:1)])}else{this._tbody.appendChild(rows[new_index])}}
this._lastSort=lastSort.previous}};RowSorter.prototype.undo=RowSorter.prototype.revert;RowSorter.prototype.destroy=function(){this._table[helperAttrName]=null;if(this._ended===!1){this._end()}
removeEvent(this._table,'mousedown',this._mousedown);removeEvent(document,'mouseup',this._mouseup);if(touchSupport){removeEvent(this._table,'touchstart',this._touchstart);removeEvent(this._table,'touchend',this._touchend)}};RowSorter.revert=function(table,suppressError){var sorter=getSorterObject(table);if(sorter===null&&suppressError===!1){throw new Error('Table not found.')}
if(sorter){sorter.revert()}};RowSorter.undo=RowSorter.revert;RowSorter.destroy=function(table,suppressError){var sorter=getSorterObject(table);if(sorter===null&&suppressError===!1){throw new Error('Table not found.')}
if(sorter){sorter.destroy()}};function getSorterObject(table){if(table instanceof RowSorter){return table}
if(typeof table==='string'){table=findTable(table)}
if(is(table,'table')&&helperAttrName in table&&table[helperAttrName]instanceof RowSorter){return table[helperAttrName]}
return null}
function findTable(query){var elements=qsa(document,query);if(elements.length>0&&is(elements[0],'table')){return elements[0]}
return null}
function is(obj,tag){return obj&&typeof obj==='object'&&'nodeName' in obj&&obj.nodeName===tag.toUpperCase()}
function moveRow(row,reference,direction){var parent=row.parentNode;if(direction===1){if(reference.nextSibling){parent.insertBefore(row,reference.nextSibling)}else{parent.appendChild(row)}}else if(direction===-1){parent.insertBefore(row,reference)}}
function rowIndex(tbody,row){var rows=tbody.rows,length=rows.length,i=0;for(;i<length;i++){if(row===rows[i]){return i}}
return-1}
function addEvent(obj,type,fn){if(obj.attachEvent){obj.attachEvent('on'+type,fn)}else{obj.addEventListener(type,fn,!1)}}
function removeEvent(obj,type,fn){if(obj.detachEvent){obj.detachEvent('on'+type,fn)}else{obj.removeEventListener(type,fn,!1)}}
function trim(str){return str.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,'')}
function hasClass(element,cls){cls=trim(cls);if(cls===''){return!1}
if(cls.indexOf(' ')!==-1){var classes=cls.replace(/\s+/g,' ').split(' '),i=0,len=classes.length;for(;i<len;i++){if(hasClass(element,classes[i])===!1){return!1}}
return!0}
if(element.classList){return!!element.classList.contains(cls)}else{return!!element.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'))}}
function addClass(element,cls){cls=trim(cls);if(cls===''){return}
if(cls.indexOf(' ')!==-1){var classes=cls.replace(/\s+/g,' ').split(' '),i=0,len=classes.length;for(;i<len;i++){addClass(element,classes[i])}
return}
if(hasClass(element,cls)===!1){if(element.classList){element.classList.add(cls)}else{element.className+=' '+cls}}}
function removeClass(element,cls){cls=trim(cls);if(cls===''){return}
if(cls.indexOf(' ')!==-1){var classes=cls.replace(/\s+/g,' ').split(' '),i=0,len=classes.length;for(;i<len;i++){removeClass(element,classes[i])}
return}
if(hasClass(element,cls)){if(element.classList){element.classList.remove(cls)}else{element.className=element.className.replace(new RegExp('(\\s|^)'+cls+'(\\s|$)'),' ')}}}
function bind(fn,context){if(Function.prototype.bind){return fn.bind(context)}
return function(){fn.apply(context,arrProto.slice.call(arguments))}}
function extend(base,from){if($){return $.extend({},base,from)}
var obj={},key;for(key in base){if(base.hasOwnProperty(key)){obj[key]=base[key]}}
if(from&&'[object Object]'===Object.prototype.toString.call(from)){for(key in from){if(from.hasOwnProperty(key)){obj[key]=from[key]}}}
return obj}
function qsa(element,query){if($){return $.makeArray($(element).find(query))}
return element.querySelectorAll(query)}
function closest(element,tag){var c=1,max=20,found=element;tag=tag.toLowerCase();while(found.tagName&&found.tagName.toLowerCase()!==tag){if(c>max||!found.parentNode){return null}
found=found.parentNode;c++}
return found}
function inArray(arr,search){if(arrProto.indexOf){return arrProto.indexOf.call(arr,search)}
for(var i=0,len=arr.length;i<len;i++){if(search===arr[i]){return i}}
return-1}
if($){$.fn.extend({rowSorter:function(options){var sorters=[];this.each(function(index,element){sorters.push(new RowSorter(element,options))});return sorters.length===1?sorters[0]:sorters}});$.rowSorter={undo:RowSorter.undo,revert:RowSorter.revert,destroy:RowSorter.destroy}}
return RowSorter});