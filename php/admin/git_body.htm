 <view:default>
<div class="container-fluid">
	<ul class="nav-tabs w_blue">
		<view:gitrepo>
		<li class="<?=$repo['class'];?>">
			<a href="/php/admin.php?_menu=git&current_repo=<?=strtolower($repo['name']);?>"><?=$repo['name'];?></a>
		</li>
		</view:gitrepo>
		<?=renderEach('gitrepo',$GITREPO,'repo');?>
	</ul>
	<div class="w_bold w_biggest w_pad"><?=isset($current_repo['path'])?$current_repo['path']:$current_repo['gitapi_path'];?></div>
	<?=renderViewIf(isset($git['error']),'error_message',$git);?>
	<?=renderViewIf(isset($git['success']),'success_message',$git);?>
	<?=renderViewIf(isset($git['warning']),'warning_message',$git);?>

	<div class="row wacss_top10">
		<div class="col-sm-9 w_padtop">
			<form method="post" name="gitform" id="gitform" action="/php/admin.php" onsubmit="return wacss.ajaxPost(this,'git_details');">
			<input type="hidden" name="_menu" value="git">
			<input type="hidden" name="func" value="">
			<input type="hidden" name="current_repo" value="<?=strtolower($current_repo['name']);?>">
			<input type="hidden" name="setprocessing" value="gitform_processing">
			<input type="hidden" name="confirm_remove" value="0">
			<input type="hidden" name="confirm_revert" value="0">
			<input type="hidden" name="sort" value="<?=isset($_REQUEST['sort'])?$_REQUEST['sort']:'';?>">
			<table class="wacss_table striped bordered hover condensed">
				<tr>
					<th><?=buildFormCheckAll('data-class','file',array('-label'=>''));?></th>
					<th>File Name</th>
					<th>Status</th>
					<th>Edited</th>
					<th>Lines</th>
					<th>Commit Message</th>
				</tr>
				<view:file>
				<tr>
					<td>
						<input type="checkbox" data-type="checkbox" _required="1" requiredmsg="No Files selected" id="id_<?=$file['sha'];?>" data-status="<?=$file['status'];?>" data-class="file" name="files[]" value="<?=$file['b64'];?>">
					</td>
					<td>
						<view:compare>
						<div class="w_right">
							<a href="#" class="w_link w_padright" data-nav="/php/admin.php" data-div="centerpop" data-title="Compare Changes - <?=getFileName($file['name']);?>" data-func="diff" data-file="<?=$file['b64'];?>" data-form="gitform" onclick="return wacss.nav(this);" title="compare"><span class="icon-compare w_orange w_big"></span></a>
							<a href="#" class="w_link w_padright" data-nav="/php/admin.php" data-div="centerpop" data-title="Commit History" data-form="gitform" data-func="log" data-file="<?=$file['b64'];?>" onclick="return wacss.nav(this);" title="view history log"><span class="icon-history w_big w_blue"></span></a>
						</div>
						</view:compare>
						<view:delete_new>
						<div class="w_right">
							<a href="#" class="w_link w_padright" data-nav="/php/admin.php" data-div="git_details" data-form="gitform" data-func="add_to_gitignore" data-file="<?=$file['b64'];?>" onclick="if(!confirm('Add <?=encodeHtml($file['name']);?> to .gitignore? File will remain but git will ignore it.')){return false;}return wacss.nav(this);" title="add to .gitignore"><span class="icon-block w_gray w_big"></span></a>
							<a href="#" class="w_link w_padright" data-nav="/php/admin.php" data-div="git_details" data-form="gitform" data-func="delete_file" data-file="<?=$file['b64'];?>" onclick="if(!confirm('Delete local file <?=encodeHtml($file['name']);?>? This cannot be undone.')){return false;}return wacss.nav(this);" title="delete local file"><span class="icon-checkbox-delete w_red w_big"></span></a>
						</div>
						</view:delete_new>
						<?=renderViewIf($file['status'] != 'new','compare',$file,'file');?>
						<?=renderViewIf($file['status'] == 'new','delete_new',$file,'file');?>
						<label for="id_<?=$file['sha'];?>" title="<?=$file['afile'];?>" class="w_pointer" style="font-weight:normal;display:inline;"><?=encodeHtml($file['name']);?></label>
					</td>
					<td><a href="#" title="Check all of this status" onclick="return checkAllElements('data-status','<?=$file['status'];?>',1);"><?=encodeHtml($file['status']);?></a></td>
					<td class="text-right"><?=isset($file['age_verbose'])?$file['age_verbose']:'';?></td>
					<td class="text-right"><?=isset($file['lines'])?$file['lines']:'';?></td>
					<td><input type="text" name="msg_<?=$file['sha'];?>" value="<?$key='msg_'.$file['sha'];return isset($_REQUEST[$key])?encodeHtml($_REQUEST[$key]):'';?>" class="wacss_input is-mobile-responsive" placeholder="commit message (3-500 chars)" maxlength="500"></td>
				</tr>
				</view:file>
				<?=renderEach('file',$git['files'],'file');?>
			</table>
			<input type="text" name="msg" value="<?=isset($_REQUEST['msg'])?encodeHtml($_REQUEST['msg']):'';?>" class="wacss_input is-mobile-responsive" placeholder="global commit message (3-500 chars)" maxlength="500">
			<div class="w_padtop" style="display:flex;gap:10px;">
				<button class="wacss_button is-mobile-responsive is-info" type="submit" onclick="document.gitform.func.value='add';"><span class="icon-plus"></span> Add</button>
				<button class="wacss_button is-mobile-responsive is-danger" type="submit" onclick="if(!confirm('Remove selected files from git tracking? This cannot be undone.')){return false;}else{document.gitform.func.value='remove';document.gitform.confirm_remove.value='1';return true;}"><span class="icon-minus"></span> Remove</button>
				<button class="wacss_button is-mobile-responsive is-warning" type="submit" onclick="if(!confirm('Revert selected files, losing all changes? This cannot be undone.')){return false;}else{document.gitform.func.value='revert';document.gitform.confirm_revert.value='1';return true;}"><span class="icon-backward"></span> Revert</button>
				<button class="wacss_button is-mobile-responsive is-success" type="submit" onclick="document.gitform.func.value='commit_push';"><span class="icon-git-push-commit"><span class="icon-mail-forward"></span></span> Commit and Push</button>
				<div id="gitform_processing" style="flex:1;"></div>
				<a href="/php/admin.php?_menu=git" class="wacss_button is-mobile-responsive"><span class="icon-refresh w_big"></span> Refresh</a>
				<a href="#" class="wacss_button is-mobile-responsive is-primary" data-nav="/php/admin.php" data-div="git_details" data-form="gitform" data-func="pull" onclick="return wacss.nav(this);"><span class="icon-download"></span> Pull</a>
			</div>
			</form>
			<div class="w_padtop" id="git_details">
				<?=renderViewIf(isset($recs[0]),'git_details',$recs,'recs');?>
			</div>
		</div>
		<div class="col-sm-3 w_padtop">
			<ul class="nav nav-tabs">
				<li class="active w_pointer"><a href="#" data-tab="1" data-nav="/php/admin.php" data-div="git_info" data-form="gitform" data-func="status" onclick="return wacss.nav(this);">Status</a></li>
				<li class="w_pointer"><a href="#" data-tab="1" data-nav="/php/admin.php" data-div="git_info" data-form="gitform" data-func="config" onclick="return wacss.nav(this);">Config</a></li>
			</ul>
			<div id="git_info" class="well w_nowrap" style="overflow:auto;">
				<?=isset($git['status'])?nl2br(encodeHtml($git['status'])):'';?>
			</div>
		</div>
	</div>
</div>
</view:default>

<view:git_status>
	<?=nl2br(encodeHtml($git['status']));?>
</view:git_status>

<view:git_config>
	<?=nl2br(encodeHtml($git['config']));?>
</view:git_config>

<view:error_message>
	<div class="alert alert-danger w_top10">
		<strong><span class="icon-warning"></span> Error:</strong> <?=encodeHtml($git['error']);?>
	</div>
</view:error_message>

<view:success_message>
	<div class="alert alert-success w_top10">
		<strong><span class="icon-check"></span> Success:</strong> <?=encodeHtml($git['success']);?>
	</div>
</view:success_message>

<view:warning_message>
	<div class="alert alert-warning w_top10">
		<strong><span class="icon-warning"></span> Warning:</strong> <?=encodeHtml($git['warning']);?>
	</div>
</view:warning_message>

<view:not_authenticated>
	<div class="container-fluid">
		<div class="alert alert-danger w_top20">
			<h3><span class="icon-lock"></span> Authentication Required</h3>
			<p>You must be logged in to access git management.</p>
			<a href="/php/admin.php?_menu=login" class="wacss_button is-primary">Login</a>
		</div>
	</div>
</view:not_authenticated>

<view:not_authorized>
	<div class="container-fluid">
		<div class="alert alert-danger w_top20">
			<h3><span class="icon-lock"></span> Access Denied</h3>
			<p>You must be an administrator to access git management.</p>
			<p>This security violation has been logged.</p>
		</div>
	</div>
</view:not_authorized>

<view:not_enabled>
	<div class="container-fluid">
		<div class="alert alert-warning w_top20">
			<h3><span class="icon-warning"></span> Git is not Enabled</h3>
			<p>To enable git management, use the settings option in the top right menu.</p>
			<ul>
				<li>Set <strong>wasql_git</strong> to <code>1</code></li>
				<li>Set <strong>wasql_git_path</strong> to your repository path</li>
			</ul>
		</div>
	</div>
</view:not_enabled>

<view:invalid_path>
	<div class="container-fluid">
		<div class="alert alert-danger w_top20">
			<h3><span class="icon-warning"></span> Invalid Git Path</h3>
			<p>The configured git path is invalid or not a git repository.</p>
			<p>To set the git path, use the settings option in the top right menu.</p>
			<ul>
				<li>Ensure the path exists and is accessible</li>
				<li>Ensure it contains a <code>.git</code> directory</li>
				<li>Check file system permissions</li>
			</ul>
		</div>
	</div>
</view:invalid_path>

<view:no_repos_configured>
	<div class="container-fluid">
		<div class="alert alert-warning w_top20">
			<h3><span class="icon-warning"></span> No Git Repositories Configured</h3>
			<p>No git repositories are configured in config.xml.</p>
			<p>To configure git repositories, add <code>&lt;gitrepo&gt;</code> tags to your config.xml file:</p>
			<pre>&lt;gitrepo
    name="MyRepo"
    path="d:/path/to/repo"
    provider="github"
    token="your_token_here"
    owner="username"
    repo="repository"
    branch="master"
/&gt;</pre>
			<p><small>Note: Attributes can use either format: <code>token</code> or <code>gitapi_token</code>, <code>owner</code> or <code>gitapi_owner</code>, etc.</small></p>
			<p>You can add multiple <code>&lt;gitrepo&gt;</code> tags to manage multiple repositories.</p>
		</div>
	</div>
</view:no_repos_configured>

<view:invalid_repo_path>
	<div class="container-fluid">
		<div class="alert alert-danger w_top20">
			<h3><span class="icon-warning"></span> Invalid Repository Path</h3>
			<p>The path specified for repository <strong><?=$current_repo['name'];?></strong> is invalid or does not exist.</p>
			<p>Path: <code><?=isset($current_repo['path'])?$current_repo['path']:$current_repo['gitapi_path'];?></code></p>
			<p>Check your config.xml and ensure the <code>&lt;gitrepo&gt;</code> tag's <code>path</code> attribute points to a valid directory.</p>
		</div>
	</div>
</view:invalid_repo_path>

<view:details>
		<textarea style="width:700px;height:400px;" data-behavior="<?=$behavior;?>"><?=encodeHtml($content);?></textarea>
</view:details>

<view:git_diff>
<div data-onload="wacss.centerpopCenter();">
	<view:rec>
		<div class="<?=$rec['class'];?>"><?=$rec['line'];?></div>
	</view:rec>
	<?=renderEach('rec',$recs,'rec');?>
</div>
</view:git_diff>

<view:git_log>
	<view:rec>
		<div><?=encodeHtml($rec);?></div>
	</view:rec>
	<?=renderEach('rec',$recs,'rec');?>
</view:git_log>

<view:git_details>
	<div data-onload="<?=isset($git['deleted_sha'])?'gitRemoveDeletedRow(\''.$git['deleted_sha'].'\')':'';?>">
	<view:rec>
		<div><?=encodeHtml($rec);?></div>
	</view:rec>
	<?=renderEach('rec',$recs,'rec');?>
	</div>
</view:git_details>

<view:git_error>
	<?=printValue($git);?>
</view:git_error>

<script>
function gitRemoveDeletedRow(sha){
	// Find the checkbox with this sha
	var checkbox = document.getElementById('id_' + sha);
	if(checkbox){
		// Find the parent row
		var row = checkbox.closest('tr');
		if(row){
			// Fade out and remove the row
			row.style.transition = 'opacity 0.5s';
			row.style.opacity = '0';
			setTimeout(function(){
				row.remove();
			}, 500);
		}
	}
}
</script>

