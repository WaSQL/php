<view:default>
<script type="text/javascript">
	function codepromptCheckKey(e){
		e = e || window.event;
        //keycodes: F8=119, CTRL-ENTER=10
	    if (e.keyCode == 119) {
			codepromptSetFunc('code')
			return codepromptSubmit(document.codeprompt);
	    }
	    else if (e.ctrlKey && e.keyCode === 13) {
	    	//CTRL+ENTER
	    	codepromptSetFunc('code')
			return codepromptSubmit(document.codeprompt);
	    }
	    else if (e.ctrlKey && e.keyCode === 69) {
	    	//CTRL+e
	    	codepromptSetFunc('code')
			return codepromptSubmit(document.codeprompt);
	    }
	    else{
	    	//console.log('Keycode:'+e.keyCode);
	    }
	}
	function codepromptSetFunc(v){
		document.codeprompt.func.value=v;
	}
	function codepromptFields(table){
		var t=getText(table+'_fields');
		if(t.length){
			setText(table+'_fields','');
			return;
		}
		var db=document.sqlprompt.db.value;
		return wacss.ajaxGet('/php/admin.php',table+'_fields',{_menu:'codeprompt',func:'fields',table:table,db:db})
	}
	function codepromptSetLang(lang){
		let func='setlang_'+lang;
		return wacss.ajaxGet('/php/admin.php','code_full',{_menu:'codeprompt',func:func,setprocessing:0})
	}
	function codepromptSubmit(frm){
		frm.code_select.value=getSelText(frm.code_full);
		return wacss.ajaxPost(frm,'codeprompt_results');
	}
	function codepromptSetActiveLang(){
		const textarea = document.getElementById('code_full');
        if (!textarea) {return false;}
        const content = textarea.value;
        // 1. Get the first line
        const firstLine = content.split('\n')[0];
        // 2. Strip surrounding whitespace and convert to lowercase for robust comparison
        const trimmedLine = firstLine.trim().toLowerCase();
        const prefix = '<'+'?';
        if (trimmedLine.startsWith(prefix)) {
            // 4. Strip the prefix (length is 2) and return the rest
            const languageTag = trimmedLine.substring(prefix.length);
            // Optional: You might want to strip trailing whitespace if any exists after the tag
            let lang='php';
            switch(languageTag.trim()){
            	case 'python':
            	case 'py':
            		lang='python';
            	break;
            	case 'perl':
            	case 'pl':
            		lang='perl';
            	break;
            	case 'r':
            		lang='r';
            	break;
            	case 'tcl':
            		lang='tcl';
            	break;
            	case 'node':
            	case 'nodejs':
            		lang='node';
            	break;
            	case 'lua':
            		lang='lua';
            	break;
            	case 'ruby':
            	case 'rb':
            		lang='ruby';
            	break;
            	case 'julia':
            	case 'jl':
            		lang='julia';
            	break;
            	case 'bash':
            	case 'sh':
            		lang='bash';
            	break;
            	case 'powershell':
            	case 'pwsh':
            	case 'ps1':
            		lang='powershell';
            	break;
            	case 'groovy':
            	case 'gsh':
            		lang='groovy';
            	break;
            	case 'vbscript':
            	case 'vbs':
            		lang='vbscript';
            	break;
            }
            wacss.setActiveTab('lang_tab_'+lang);
            return false;
        }
        // 5. If it doesn't match the prefix, return an empty string (or the full line, depending on required behavior)
        return false;
	}
	document.onkeydown = codepromptCheckKey;
</script>
<div style="display:flex;flex-direction:column;">
	<div class="wacss_buttons" style="flex-wrap:wrap;gap:1px;margin-top:10px;">
		<!-- PHP -->
		<button id="lang_tab_php" type="button" class="is-active wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('php')" title="PHP"><span class="icon-program-php wacss_right3"></span> PHP</button>
		<!-- Python -->
		<button id="lang_tab_python" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('py')" title="Python"><span class="icon-program-python wacss_right3"></span>Python</button>
		<!-- Perl -->
		<button id="lang_tab_perl" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('pl')" title="Perl"><span class="icon-program-perl wacss_right3"></span>Perl</button>
		<!-- R -->
		<button id="lang_tab_r" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('r')" title="R"><span class="icon-program-r wacss_right3"></span>R</button>
		<!-- Tcl -->
		<button id="lang_tab_tcl" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('tcl')" title="Tcl"><span class="icon-program-tcl wacss_right3"></span>Tcl</button>
		<!-- Node -->
		<button id="lang_tab_node" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('node')" title="Node"><span class="icon-program-nodejs wacss_right3"></span>Node</button>
		<!-- Lua -->
		<button id="lang_tab_lua" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('lua')" title="Lua"><span class="icon-program-lua wacss_right3"></span>Lua</button>
		<!-- Ruby -->
		<button id="lang_tab_ruby" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('rb')" title="Ruby"><span class="icon-program-ruby wacss_right3"></span>Ruby</button>
		<!-- Julia -->
		<button id="lang_tab_julia" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('julia')" title="Julia">Julia</button>
		<!-- Bash -->
		<button id="lang_tab_bash" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('bash')" title="Bash"><span class="icon-terminal wacss_right3"></span>Bash</button>
		<!-- Powershell -->
		<button id="lang_tab_powershell" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('powershell')" title="PowerShell"><span class="icon-program-powershell wacss_right3"></span>PowerShell</button>
		<!-- Groovy -->
		<button id="lang_tab_groovy" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('groovy')" title="Groovy"><span class="icon-program-groovy wacss_right3"></span>Groovy</button>
		<!-- VBScript -->
		<button id="lang_tab_vbscript" type="button" class="wacss_button is-tab is-small is-outlined is-mobile-responsive <?=configValue('admin_color');?>" onclick="wacss.setActiveTab(this);codepromptSetLang('vbs')" title="VBScript"><span class="icon-program-vbscript wacss_right3"></span>VBScript</button>
	</div>
	<form method="post" action="<?=$CONFIG['codeprompt_path'];?>" data-setprocessing="codeprompt_processing" name="codeprompt" onsubmit="return codepromptSubmit(this);" data-onload="codepromptSetActiveLang();">
		<input type="hidden" name="_menu" value="codeprompt">
		<input type="hidden" name="func" value="code">
		<input type="hidden" name="code_select" value="">
		<textarea class="wacss_textarea" autofocus="true" data-behavior="loadtextfile tabs" style="height:250px;padding:10px;" placeholder="Code" id="code_full" name="code_full"><?=codepromptGetValue();?></textarea>
		<div class="w_padtop" style="display:flex;justify-content: space-between;">
			<div style="display:flex;">
				<button style="align-self:center;" type="submit" onclick="codepromptSetFunc('code');" class="wacss_button  is-mobile-responsive <?=configValue('admin_color');?>">Run Input Contents</button>
				<div  style="margin-left:15px;align-self:center;" id="codeprompt_processing"></div>
			</div>
			<div>
				<button type="submit" onclick="codepromptSetFunc('code_prompt_load');" class="wacss_button  is-mobile-responsive <?=configValue('admin_color');?> is-outlined"><span class="icon-history wacss_right5"></span> Load Code Prompt</button>
			</div>
		</div>
	</form>
	<div id="codeprompt_results" style="flex:1;padding:10px 0;"></div>
</div>
</view:default>

<view:results>
	<?=$results;?>
	<view:code_prompt>
		<textarea id="code_prompt" style="display:none"><?=$code_full;?></textarea>
	<?=buildOnLoad("document.codeprompt.reset();setText('code_full',getText('code_prompt'));");?>
	</view:code_prompt>
</view:results>

<view:code_prompt_load>
	<textarea id="code_prompt" style="display:none"><?=$code_full;?></textarea>
	<?=buildOnLoad("document.codeprompt.reset();setText('code_full',getText('code_prompt'));");?>
</view:code_prompt_load>

