<view:default>
<script language="javascript">
function pauseSelected(func){
	var clist=document.querySelectorAll('input[type="checkbox"][name="cronid[]"]:checked');
	//console.log(clist);
	if(clist.length==0){alert('No crons selected to pause');return;}
	let ids=new Array();
	for(let i=0;i<clist.length;i++){
		ids.push(clist[i].value);
	}
	return ajaxGet('<?=configValue('admin_form_url');?>','cron_results',{_menu:'cron',func:func,title:'Pause Crons',ids:ids,setprocessing:0});
}
function cronFilterByGroup(name){
	pagingClearFilters();
	document.searchfiltersform.filter_field.value='groupname';
	document.searchfiltersform.filter_operator.value='eq';
	document.searchfiltersform.filter_value.value=name;
	return pagingSubmit(document.searchfiltersform,'cron_results');
}
function cronRefreshResult(cron_id,id){
	return ajaxGet('<?=configValue('admin_form_url');?>','cron_result',{_menu:'cron',func:'cron_result',setprocessing:'setprocessing',cron_id:cron_id,id:id});
}
function cronResultScroll(cron_id,id,run_length){
	document.getElementById('cron_result_textarea').scrollTop=document.getElementById('cron_result_textarea').scrollHeight;
	setTimeout(function(){cronRefreshResult(cron_id,id);},6000);
	setText('run_length_'+id,run_length);
}
function cronModal(func,id,title){
	return ajaxGet('<?=configValue('admin_form_url');?>','modal',{_menu:'cron',func:func,id:id,title:title,setprocessing:'cron_processing'});
}
</script>
<h2 style="margin:0px;padding:6px;" class="<?=configValue('admin_color');?>"><span class="icon-cron"></span> <translate>Cron Manager</translate></h2>
<div id="cron_results" class="w_padtop">
	<?=renderView('list');?>
</div>
</view:default>

<view:list>
	<div class="w_right">
		<a href="#" onclick="return cronModal('add',0,this.title);" title="<translate>Add New Cron</translate>" class="btn <?=configValue('admin_color');?>"><span class="icon-plus"></span> <translate>Add New</translate></a>
		<a href="#" onclick="return pagingSubmit(document.searchfiltersform,'cron_results');" title="<translate>Refresh</translate>" class="btn <?=configValue('admin_color');?>"><span class="icon-refresh"></span></a>
	</div>
	<?=cronList();?>
	<div class="align-left">
		<button type="button" class="button btn <?=configValue('admin_color');?>" onclick="pauseSelected('pause')"><span class="icon-spin8 w_danger" style="border-radius:15px;background:#fefcab;"></span> Pause Selected</button>
		<button type="button" class="button btn <?=configValue('admin_color');?>" onclick="pauseSelected('unpause')"><span class="icon-spin8 w_danger" style="border-radius:15px;background:#fefcab;"></span> Unpause Selected</button>
	</div>
	<?=buildOnLoad("wacss.modalClose();");?>
</view:list>

<view:addedit>
	<?=cronAddEdit($id);?>
</view:addedit>

<view:add_fields>
<div class="row">
	<div class="col s6 m5"><label class="w_red"><translate>Cron Name</translate></label>[name]</div>
	<div class="col s6 m1"><label><translate>Active</translate></label>[active]</div>
	<div class="col s6 m3"><label><translate>Begin Date</translate></label>[begin_date]</div>
	<div class="col s6 m3"><label><translate>End Date</translate></label>[end_date]</div>
</div>
<div class="row">
	<div class="col s12 m4"><label><translate>Quick Pick Frequency</translate></label>[frequency]</div>
	<div class="col s12 m1"><br />OR</div>
	<div class="col s12 m7"><label><translate>Custom Frequency</translate></label>[run_format]</div>
</div>
<div class="row">
	<div class="col s12 m8"><label class="w_red"><translate>Run Cmd: (command, page name, or url)</translate></label>[run_cmd]</div>
	<div class="col s12 m4"><label><translate>Run As</translate></label>[run_as]</div>
</div>
</view:add_fields>

<view:edit_fields>
<div class="row">
	<div class="col s12 m6"><label class="w_red"><translate>Cron Name</translate></label>[name]</div>
	<div class="col s12 m6"><label><translate>Groupname</translate></label>[groupname]</div>
</div>
<div class="row">
	<div class="col s6 m1"><label><translate>Paused</translate></label>[paused]</div>
	<div class="col s6 m1"><label><translate>Active</translate></label>[active]</div>
	<div class="col s6 m3"><label><translate>Records To Keep</translate></label>[records_to_keep]</div>
	<div class="col s6 m3"><label><translate>Begin Date</translate></label>[begin_date]</div>
	<div class="col s6 m3"><label><translate>End Date</translate></label>[end_date]</div>
</div>
<div class="row">
	<div class="col s12 m4"><label><translate>Quick Pick Frequency</translate></label>[frequency]</div>
	<div class="col s12 m1"><br />OR</div>
	<div class="col s12 m7"><label><translate>Custom Frequency</translate></label>[run_format]</div>
</div>
<div class="row">
	<div class="col s12"><label class="w_red"><translate>Run Cmd: (command, page name, or url)</translate></label>[run_cmd]</div>
</div>
<div class="row">
	<div class="col s6 m5"><label><translate>Run As</translate></label>[run_as]</div>
	<div class="col s6 m1"><label class="w_gray"><translate>Running</translate></label>[running]</div>
	<div class="col s6 m3"><label class="w_gray"><translate>Last Run Date</translate></label>[run_date]</div>
	<div class="col s6 m3"><label class="w_gray"><translate>Last Run Length</translate></label>[run_length]</div>
</div>
<div class="row">
	<div class="col s12"><label class="w_gray"><translate>Last Run Result</translate></label>[run_result]</div>
</div>
<div class="row">
	<div class="col s12"><label class="w_gray"><translate>Last Error (if any)</translate></label>[run_error]</div>
</div>
</view:edit_fields>


<view:groupnames>
	<ul class="nav-tabs <?=configValue('admin_color');?>">
		<view:groupname><li><a href="#" onclick="cronFilterByGroup('<?=$rec['groupname'];?>');"><?=$rec['groupname'];?></a></li></view:groupname>
		<?=renderEach('groupname',$recs,'rec');?>
	</ul>
</view:groupnames>


<view:details>
<div class="row">
	<div class="col s12">
		<table class="table condensed striped bordered <?=configValue('admin_color');?>">
			<tr>
				<th><translate>ID</translate></th>
				<th><translate>Group</translate></th>
				<th><translate>Name</translate></th>
				<th><translate>Active</translate></th>
				<th><translate>Paused</translate></th>
				<th><translate>Running</translate></th>
				<th><translate>LogMax</translate></th>
				<th><translate>Cmd</translate></th>
				<th><translate>Frequency</translate></th>
				<th><translate>Actions</translate></th>
			</tr>
			<tr>
				<td class="w_small"><?=$cron['_id'];?></td>
				<td class="w_small"><?=$cron['groupname'];?></td>
				<td class="w_small"><?=$cron['name'];?></td>
				<td class="w_small align-center"><?=cronIsActive($cron);?></td>
				<td class="w_small align-center"><?=cronIsPaused($cron);?></td>
				<td class="w_small align-center" id="is_running"><?=cronIsRunning($cron);?></td>
				<td class="w_small"><?=$cron['records_to_keep'];?></td>
				<td class="w_small"><?=$cron['run_cmd'];?></td>
				<td class="w_small"><?=$cron['run_format'];?></td>
				<td>
					<a href="#" class="w_link w_block" onclick="return cronModal('edit',<?=$cron['_id'];?>,this.title);" title="Edit Cron"><span class="icon-edit w_gray"></span></a>
					<a href="#" style="margin-left:5px;" class="w_link w_block" onclick="return cronModal('details',<?=$cron['_id'];?>,this.title);" title="Refresh"><span class="icon-refresh w_primary"></span></a>
					<a href="#" style="margin-left:5px;" class="w_link w_block" onclick="return cronModal('run',<?=$cron['_id'];?>,this.title);" title="Run Now"><span class="icon-play w_success"></span></a>
					<span id="cron_processing"></span>
				</td>
			</tr>
		</table>
	</div>
</div>
<div class="row">
	<div class="col s4">
		<div style="max-height:400px;overflow:auto;padding-right:20px;">
		<table class="table condensed striped bordered <?=configValue('admin_color');?> hover">
		<tr>
			<th><translate>RunDate</translate></th>
			<th><translate>RunTime</translate></th>
			<th></th>
		</tr>
		<view:log>
		<tr class="w_pointer" onclick="return cronRefreshResult(<?=$log['cron_id'];?>,<?=$log['_id'];?>);">
			<td class="w_nowrap" id="run_date_<?=$log['_id'];?>"><?=$log['run_date'];?></td>
			<td class="" id="run_length_<?=$log['_id'];?>"><?=verboseTime($log['run_length']);?></td>
			<td><div class="align-middle" style="margin-top:2px;background-color:<?=$log['color'];?>;height:12px;width:12px;border-radius:6px;"></div></span></td>
		</tr>
		</view:log>
		<?=renderEach('log',$cron['logs'],'log');?>
		</table>
		</div>
	</div>
	<div class="col s8"><div id="cron_result" style="width:560px;">
		<?=renderView('cron_result',$cron,'log');?>
	</div></div>
</div>
</view:details>

<view:cron_result>
<view:error>
<textarea style="border:1px solid #d9534f;width:100%;height:60px;font-size:0.9rem;color:#d9534f;margin-bottom:5px;" wrap="soft">
<?=$log['run_error'];?>
</textarea>
</view:error>
<?=renderViewIf(strlen($log['run_error']),'error',$log,'log');?>
<textarea id="cron_result_textarea" style="border:1px solid #f1f1f1;border-right:0px;border-bottom:0px;width:100%;height:400px;font-size:0.9rem;color:#000000CC" wrap="off">
<?=$log['run_result'];?>
</textarea>
<view:bottom>
<div id="setprocessing" style="float:right;position:absolute;top:70px;right:20px;color:#CCC;font-size:0.8rem;" data-behavior="countdown">7</div>
<?=buildOnLoad("cronResultScroll({$log['bottom']});");?>
</view:bottom>
<?=renderViewIf(strlen($log['bottom']),'bottom',$log,'log');?>
<view:not_running><?=buildOnLoad("setText('is_running','');setText('run_date_0','Not Running');");?></view:not_running>
<?=renderViewIf($log['run_result']=='No longer running','not_running');?>
</view:cron_result>